<html>
<head>
<meta charset='utf-8'>
<title>untitled</title>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>

body {
    margin: 5px;
}
table {
    border-collapse: collapse;
}
th, td {
    padding: 0px;
}

</style>
</head>
<body>
<script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>
<script src="http://dglittle.github.io/gl519/index.js"></script>
<script src="http://dglittle.github.io/gl519/random.js"></script>
<script src="utils.js"></script>
<script>

tau = Math.PI * 2

function dot(a, b) {
	var sum = 0
	for (var i = 0; i < a.length; i++)
		sum += a[i] * b[i]
	return sum
}

function sub(a, b) {
	var x = []
	for (var i = 0; i < a.length; i++)
		x[i] = a[i] - b[i]
	return x
}

function mul(a, b) {
	var x = []
	for (var i = 0; i < a.length; i++)
		x[i] = a[i] * b[i]
	return x
}

function mag(a) {
	return Math.sqrt(dot(a, a))
}

function angleBetween(a, b) {
	return Math.acos(dot(a, b) / (mag(a) * mag(b)))
}

function createRandomColor(buckets) {
	function rand() {
		var x = Math.floor(Math.random() * buckets)
		return Math.floor(_.lerp(0, 0, buckets - 1, 255, x))
	}
	while (true) {
		var c = [rand(), rand(), rand()]
		if (mag(c) != 0) return c
	}
}

function colorToCss(c) {
	return 'rgb(' + _.map(c, function (x) { return Math.floor(x) }).join(',') + ')'
}

function addSliderControl(d, cb) {
	function getRelPos(d, e) {
		var offset = d.offset()
		return [e.pageX - offset.left, e.pageY - offset.top]
	}

	d.mousedown(function (e) {
		e.preventDefault()
		var pos = getRelPos(d, e)
		cb(pos[0], pos[1])

        var oldMove = document.onmousemove
        document.onmousemove = function (e) {
			var pos = getRelPos(d, e)
			cb(pos[0], pos[1])
        }
        
        var oldUp = document.onmouseup
        document.onmouseup = function (e) {
            document.onmousemove = oldMove
            document.onmouseup = oldUp
        }
	})

    d[0].ontouchstart = function (e) {
        e.preventDefault()
        var pos = getRelPos(d, e.touches[0])
		cb(pos[0], pos[1])

        var oldMove = document.ontouchmove
        document.ontouchmove = function (e) {
            e.preventDefault()
	        var pos = getRelPos(d, e.touches[0])
			cb(pos[0], pos[1])
        }

        var oldEnd = document.ontouchend
        var oldCancel = document.ontouchcancel
        document.ontouchend = document.ontouchcancel = function (e) {
            document.ontouchmove = oldMove
            document.ontouchend = oldEnd
            document.ontouchcancel = oldCancel
        }
    }	
}

function drawColorSlider(buckets, comp, init, cb) {
	function getColor(x) {
		var c = [0, 0, 0]
		c[comp] = x
		return c
	}
	var h = 60
	var d = $('<div style="width:100%;height:' + h + 'px;"/>')

	var table = '<table style="width:100%;height:100%"><tr>'
	for (var i = 0; i < buckets; i++) {
		table += '<td class="' + i + '" width="' + (100 / buckets) + '%" style="padding:2px;"><div style="width:100%;height:100%;background:' + colorToCss(getColor(_.lerp(0, 0, buckets - 1, 255, i))) + '"></div></td>'
	}
	table += '</tr></table>'
	d.append($(table))

	var slider = $('<div style="position:absolute;border:1px solid black"/>')
	d.append(slider)

	var update = function (x) {
		var w = d.width() - 1
		if (x < 0) x = 0
		if (x > w) x = w
		x = Math.floor(_.lerp(0, 0, w + 1, buckets, x))
		var dd = d.find('.' + x)
		var pos = dd.offset()
		slider.css({
			left : pos.left + 'px',
			top : pos.top + 'px',
			width : dd.width() + 2,
			height : dd.height() + 2
		})

		x = Math.floor(_.lerp(0, 0, buckets - 1, 255, x))
		cb(x)
	}
	addSliderControl(d, update)
	setTimeout(function () {
		if (init != null)
			update(_.lerp(0, 0, 255, d.width() - 1, init))
	}, 0)
	return d
}

function getYards(c1, c2, buckets) {
	function bucketize(c) {
		var cc = []
		for (var i = 0; i < c.length; i++)
			cc.push(Math.round(_.lerp(0, 0, 255, buckets - 1, c[i])))
		return cc
	}
	c1 = bucketize(c1)
	c2 = bucketize(c2)
	var sum = 0
	for (var i = 0; i < c1.length; i++)
		sum += Math.abs(c1[i] - c2[i])
	return sum

	// return Math.floor(_.lerp(0, 0, mag([255, 255, 255]), 300, mag(mul(sub(c1, c2), [1, 1, 1]))))
	// return Math.floor(_.lerp(0, 0, mag([255, 255, 255]), 300, mag(mul(sub(c1, c2), [0.2126, 0.7152, 0.0722]))))
}

function drawState(state) {

	if (state.strokes.length == state.maxHoles + 1) {
		var d = $('<div/>')
		function text(d, t) {
			d.append($('<div/>').html(t))
		}
		text(d, 'final score: ' + _.sum(state.strokes))

		var left = $('<div/>')
		var right = $('<div/>')
		_.each(state.strokes, function (s, i) {
			if (s > 0) text(i < 9 ? left : right, '<span style="color:' + colorToCss(state.colors[i]) + '">●</span> hole ' + (i + 1) + ', strokes ' + s)
		})
		d.append(_.splitHorz(.5, .5, left, right, false).css('width', '100%'))

		var swingButton = $('<button style="height:40px;width:100%;margin-top:5px"/>').text('play again!').click(function () {
			g_div.empty().append(drawState(createState()))
		})
		d.append(swingButton)

		return d
	}

	var flagColor = state.colors[state.colors.length - 1]
	var yards = getYards(flagColor, state.ballColor, state.colorBuckets)
	var done = yards == 0

	var info = $('<div style="margin-bottom:5px"/>').text('hole ' + state.strokes.length + ' — strokes ' + state.strokes[state.strokes.length - 1] + ' — total ' + _.sum(state.strokes))

	var ball = _.splitVert(1, 2, $('<div style="width:100%;height:100%;background:' + colorToCss(state.ballColor) + '">'), center($('<div/>').text('ball')))

	var flag = _.splitVert(1, 2, $('<div style="width:100%;height:100%;background:' + colorToCss(flagColor) + '">'), center($('<div/>').text(yards == 0 ? 'perfect!' : done ? 'good enough!' : 'flag at ' + yards + ' yards')))

	var flagBall = _.splitHorz(.5, .5, ball, flag)

	var sliders = $('<div style="margin-top:5px"/>')
	_.each(_.range(3), function (i) {
		sliders.append(drawColorSlider(state.colorBuckets, i, state.swingColor[i], function (x) {
			state.swingColor[i] = x
		}))
	})

	if (done) {
		if (state.strokes.length == state.maxHoles) {
			var swingButton = $('<button style="height:40px;width:100%;margin-top:5px"/>').text('see results!').click(function () {
				stateNewHole(state)
				g_div.empty().append(drawState(state))
			})
		} else {
			var swingButton = $('<button style="height:40px;width:100%;margin-top:5px"/>').text('next hole!').click(function () {
				stateNewHole(state)
				g_div.empty().append(drawState(state))
			})
		}
	} else {
		var swingButton = $('<button style="height:40px;width:100%;margin-top:5px"/>').text('swing!').click(function () {
			stateSwing(state)
			g_div.empty().append(drawState(state))
		})
	}

	return _.splitVert(2, 1, info,
		_.splitVert(1, 2, flagBall,
			$('<div/>').append(sliders).append(swingButton)))
}

function createState() {
	var state = {}
	state.maxHoles = 18
	state.colorBuckets = 8
	state.strokes = []
	state.colors = []
	stateNewHole(state)
	return state
}

function stateNewHole(state) {
	state.strokes.push(0)
	state.colors.push(createRandomColor(state.colorBuckets))
	state.ballColor = [0, 0, 0]
	state.swingColor = [0, 0, 0]
}

function stateSwing(state) {
	state.strokes[state.strokes.length - 1]++
	state.ballColor = state.swingColor
	state.swingColor = state.ballColor.slice(0)
}

$(function () {
	$('body').append($('<a href="https://github.com/dglittle/color-golf"><img width="64px" style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub"></a>'))

	g_div = $('<div style="width:300px;height:400px"/>')
	g_div.append(drawState(createState()))
	$('body').append(g_div)

	$.ajax({
	    url : 'http://view-count.herokuapp.com/view/' +
	        encodeURIComponent(location.href),
	    xhrFields : { withCredentials: true },
	    success : function (count) {
	    	$('body').append($('<div style="font-size:small;color:lightgrey"/>').text('view count ' + count))
	    }
	})   	
})

</script>
</body>
</html>
